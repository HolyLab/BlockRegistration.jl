<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Components of registration · BlockRegistration.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">BlockRegistration.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../cookbook/">Stack-by-stack optimization: a cookbook</a></li><li class="is-active"><a class="tocitem" href>Components of registration</a><ul class="internal"><li><a class="tocitem" href="#Apertured-mismatch-1"><span>Apertured mismatch</span></a></li><li><a class="tocitem" href="#Regularization-1"><span>Regularization</span></a></li><li><a class="tocitem" href="#Temporal-regularization-1"><span>Temporal regularization</span></a></li></ul></li><li><a class="tocitem" href="../improving/">Improving alignment</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Components of registration</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Components of registration</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/HolyLab/BlockRegistration.jl/blob/master/docs/src/details.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Components-of-registration-1"><a class="docs-heading-anchor" href="#Components-of-registration-1">Components of registration</a><a class="docs-heading-anchor-permalink" href="#Components-of-registration-1" title="Permalink"></a></h1><h2 id="Apertured-mismatch-1"><a class="docs-heading-anchor" href="#Apertured-mismatch-1">Apertured mismatch</a><a class="docs-heading-anchor-permalink" href="#Apertured-mismatch-1" title="Permalink"></a></h2><p>As described in the documentation for <a href="https://github.com/HolyLab/RegisterCore.jl">RegisterCore</a>, the mismatch between images is represented using an array where each element corresponds to a shift (translation) of a block of the image. From the demo in the <a href="../cookbook/#cookbook-1">cookbook</a>, we can select a particular moving image, compute the mismatch, and visualize it:</p><pre><code class="language-julia">moving = img[:,:,1]
mms = mismatch_apertures(fixed, moving, aperture_centers, aperture_width, mxshift)
# Turn the mismatch from NumDenom to a plain ratio (see RegisterCore docs)
rat(x) = ratio(x, thresh)
mmsr = map(mm-&gt;rat.(mm), mms)
# Concatenate so we can see the whole 3×3 grid of mismatch arrays
mmall = hvcat((3,3,3), parent.(mmsr)...)
maximum(mmall)</code></pre><p>If you visualize <code>mmall</code>, you&#39;ll see something like this:</p><p><img src="../assets/mm.png" alt="mmall"/></p><p>This is a heatmap representing the mismatch data in each element of the 3×3 grid of apertures. The center of each square corresponds to &quot;no shift&quot;; as one moves towards the edge one gets to the <code>mxshift</code> that we chose. Darker means lower mismatch (with zero being black), and lighter meaning higher mismatch. For example, the left-center aperture has a minimum that is displaced vertically from the center; if you look back at the images at the end of the previous page, you can convince yourself that the left side of the moving image is indeed shifted vertically. This aperture&#39;s minimum is also relatively isotropic, reflecting the fact that the image has &quot;features&quot; that define both the vertical and horizontal shift with approximately similar precision. Conversely, in other regions the penalty for some movements is quite different from the penalty for others. For example, the right-center aperture is &quot;forgiving&quot; of shifts that have only a slight tilt from vertical; this is because the tripod leg on the right side of the image is the highest-contrast feature, and sliding along the axis of the leg introduces much less mismatch than sliding perpendicularly to the leg.</p><h2 id="Regularization-1"><a class="docs-heading-anchor" href="#Regularization-1">Regularization</a><a class="docs-heading-anchor-permalink" href="#Regularization-1" title="Permalink"></a></h2><p>The &quot;naive&quot; optimum deformation is set by choosing the lowest value in each of these apertures. However, because some apertures have very little to constrain them (e.g., lower left), we additionally enforce &quot;smoothness&quot; in the deformation with the <code>AffinePenalty</code>, whose magnitude it set by <code>λ</code>. You can specify the value of <code>λ</code> yourself, or you can allow the algorithm to choose it for you.</p><p>If one repeats the calculation in our cookbook up through <code>auto_λ</code>, plotting <code>λvec</code> (vector of tested <code>λ</code> values) vs <code>dp</code> (&quot;data penalty&quot;) yields the following graph:</p><p><img src="../assets/lambda.png" alt="lambda"/></p><p>Larger values of <code>λ</code> force the deformation to become closer to an affine transformation. Since the actual underlying transformation is <em>not</em> affine, large <code>λ</code> values force the optimizer to choose a lower-quality alignment in order to make the deformation affine. For this reason, the data penalty is higher at large <code>λ</code>.</p><p>Roughly speaking, <code>auto_λ</code> attempts to choose <code>λ</code> so that one is near the lower kink in the sigmoid–-where <code>λ</code> is starting to make a difference, but that you&#39;re still dominated by the data. To ensure that this happens correctly, you need to choose a <code>λrange</code> that effectively spans the sigmoid.</p><p>The automatic choice may not be ideal (and it certainly takes more computation time), so you might consider experimenting with different <code>λ</code> and seeing which choice gives the best alignment.</p><h2 id="Temporal-regularization-1"><a class="docs-heading-anchor" href="#Temporal-regularization-1">Temporal regularization</a><a class="docs-heading-anchor-permalink" href="#Temporal-regularization-1" title="Permalink"></a></h2><p>There is also a &quot;whole experiment&quot; mode that optimizes deformations for all images in a sequence simultaneously. In this mode, one can also supply a <code>λt</code>, which is a regularizer for changes in <code>λ</code> over time. This regularizer currently penalizes the sum-of-squared differences across time. Because real-world experiments sometimes have sudden movements, and the sum-of-squared differences smooths those transitions out, this mode is not currently recommended.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../cookbook/">« Stack-by-stack optimization: a cookbook</a><a class="docs-footer-nextpage" href="../improving/">Improving alignment »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 3 February 2020 22:22">Monday 3 February 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
